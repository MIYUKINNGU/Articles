<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link rel="stylesheet" href="../index.css" type="text/css">
        <title>MIYUKINNGUの技術記事</title>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax:{inlineMath:[['\$','\$'],['\\(','\\)']],processEscapes:true},CommonHTML: {matchFontHeight:false}});window.MathJax = {chtml: {scale: 1.2,mtextInheritFont: true}};</script>
        <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    </head>
    <body>
        <div id="MathJax_Message" style="display: none;"></div>
        <header>
            MIYUKINNGUの技術記事
        </header>
        <main class="content">
            <div class="sideber-area">
                <ul>
                    <li><h2>目次</h2></li>
                    <li><a href="./index.html#introduction">はじめに(そして私事)</a></li>
                    <li><a href="./index.html#transform">まずは基本的なところから</a></li>
                    <li><a href="./index.html#movecamera">カメラを移動させてみよう</a></li>
                    <li><a href="./index.html#visualparamid">おや？描画の範囲外に行ったら様子がおかしいぞ...?</a></li>
                    <li><a href="./index.html#viewingangle">画角の変更方法</a></li>
                    <li><a href="./index.html#rotate">カメラを回転させてみよう</a></li>
                </ul>
            </div>
            <div class="main-content-area">
                <h1 class="page-title">3Dエンジンを作ってみよう</h1>
                <h2 class="text">対象読者</h2>
                <p class="text">ScratchやJavaScript、C++等のGUIが問題なく使える言語で3Dエンジン(レンダラ)を作りたい人、作ってみたい人</p>
                <p class="text">高校数学が十分に理解できている人(数ⅡBができていたら十分でしょう)</p>
                <h2 class="text" id="introduction">はじめに(そして私事)</h2>
                <p class="text">最近作っている物と言えば何でしょうか...</p>
                <p class="text">3Dレンダラですかね？理解すれば大して難しくなかったです。</p>
                <p class="text">ということで今回は3Dレンダラを作ってみようというテーマで記事を書いていきたいと思います</p>
                <p class="text">一応言っておきますが恐らくそう易々と理解できるものではないかと思います(特に回転等の計算)</p>
                <p class="text">回転の項目についてはなんとなしで理解した方が良いかと...(自分もそうですし...)</p>
                <p class="text">ってことで本題に入りましょうか</p>
                <h2 class="text" id="transform">まずは基本的なところから</h2>
                <p class="text">さあ本題に入る、とはいってもまず何をすればよいのでしょうか？</p>
                <p class="text">まあそれは結論を言ってしまえば三次元の物をどのようにしてスクリーンに写すか、ということです(この写す方法の事を投影方法と呼ぶ)</p>
                <p class="text">これには自分の知る限りでは2種類の手法があり現在一番よく使われている方法は「<b>透視投影</b>」でしょう</p>
                <p class="text">もう一方は「平行投影」と呼ばれる方法です。主にCADなどで使われる方法ですね。この投影方法は中学の技術でやったキャビネット図に相当します。</p>
                <p class="text">ですが今回はあくまで透視投影です。透視投影は皆さんゲームをやっていたら100%目にします。</p>
                <p class="text">そう、3Dゲームなどで使われる投影方法です。逆にこれ以外の投影方法となると広角レンズのような投影ができるゲームとかでしょうか...</p>
                <p class="text">ですが大体ああいうのは視覚効果で行っており根本的な投影方法は同じだったりしますからね...</p>
                <p class="text">I don't knowですな</p>
                <p class="text">まあこのような投影方法で3Dをスクリーンに写すことができるというわけです</p>
                <p class="text"></p>
                <p class="text">では早速その透視投影とやらをやってみようではないか</p>
                <p class="text">透視投影をする方法は至ってシンプル。</p>
                <p class="text">大前提はカメラの座標が原点にあることです。</p>
                <p class="text">そしてメインのアルゴリズムは...</p>
                <p class="text"><b>空間上の点のx座標y座標それぞれをz座標で割る</b></p>
                <p class="text">です。とてもシンプル。これは中学レベルの相似の考え方から導出することが可能です。暇ならやってみてください。</p>
                <p class="text">ヒントはカメラの視線を底辺とする直角三角形で考える事でしょうか？</p>
                $$\left(x',y'\right)=\left(\frac{x}{z},\frac{y}{z}\right)$$
                <p class="text">さて、これさえ理解してしまえば後は点同士を線でつなぐだけで3Dを描画できます。</p>
                <p class="text">あら簡単。もう終わりですか？(※終わりではないです)</p>
                <h2 class="text" id="movecamera">カメラを移動させてみよう</h2>
                <p class="text">さあ、こうなるとカメラを移動させたくなりますね。</p>
                <p class="text">その方法はとても簡単ですが、少ししっかり考える必要があります。</p>
                <p class="text">というのも、もし間違えてしまうと逆方向に動いてしまうからです。(まあ符号を修正すればいいだけなので大したことではないのですがね)</p>
                <p class="text">カメラが動くとき、そのカメラからの相対的な位置関係としてはオブジェクトというのは必ずカメラの動く方向の逆方向に動きます。</p>
                <p class="text">少しややこしいですね。とにかくカメラが固定されて動けなかったとしてもそう見せかけることは容易だということです</p>
                <p class="text">これで先ほどの透視投影をする大前提を満たしますね。</p>
                <p class="text">では式にしてみましょう。</p>
                <p class="text">オブジェクトの移動量を$u=\left(a,b,c\right)$とし、カメラの移動量を$v=\left(p,q,r\right)$とする。($u,v$はどちらも3次元ベクトル)</p>
                <p class="text">この時のカメラからの相対的な位置関係は</p>
                $$u-v=\left(a-p,b-q,c-r\right)$$
                <p class="text">である</p>
                <p class="text">終わりです。あとは先ほどの透視投影の式にこの式を入れれば移動については問題ありません。</p>
                <p class="text">移動は各自で操作キーを割り当てていい感じに移動できるようにしてください。スライダー方式でも問題ないでしょう</p>
                <h2 class="text" id="visualparamid">おや？描画の範囲外に行ったら様子がおかしいぞ...?</h2>
                <p class="text">ここまで読んで全て実践していたらおそらくこのことに気づいたでしょう。</p>
                <p class="text">これを解決させる方法が存在します。それは視錐台の範囲に入ったら描画するというものです</p>
                <p class="text">視錐台とは何でしょう？</p>
                <p class="text">視錐台とはカメラの視点から見える範囲のことを指し、それがこたつのような形(これを錐台という)をしていることから来ています</p>
                <!--視錐台の画像を貼る-->
                <p class="text">視錐台の範囲に入ったことを確かめるためには直線の方程式からその範囲に入っていることを地道に確認するしかないです。</p>
                <p class="text">そう、AND条件地獄です。数学の○＜x＜○とプログラミングは非常に相性が悪い...(Pythonでは謎に数学の時のように入力しても正しい評価になるが)</p>
                <p class="text">直線の方程式はax+by+cz=d(a,b,c,d∊ℝ)ですね。なので地道に比較するしかない...</p>
                <p class="text">でも実は絶対値を使うと多少楽に作れる</p>
                <p class="text">係数の値の決め方は画角から考える必要があります。ってことで次は画角の変更方法</p>
                <h2 class="text" id="viewingangle">画角の変更方法</h2>
                <p class="text">ここまで来るとみんな画角が変更したくなるものです。(知らんけど)</p>
                <p class="text">ということで画角を変更していきましょう</p>
                <p class="text">やり方は比較的シンプルですが、三角関数を使うことになります。</p>
                <p class="text">これについては画角を変更できるようにしたときに同時にDesmosでグラフ化させているので良ければぜひ見てみてください</p>
                <p class="text"><a href="https://www.desmos.com/calculator/vorrseafx8">画角と座標変換の式の関係 - desmos</a></p>
                <p class="text">一応このグラフで注釈をするとcot(x)は1/tan(x)と等しいです。つまりtan(x)の逆数ですね。(逆関数じゃあないよ！)</p>
                <p class="text">導出はスクリーンの高さの1/2を直角三角形の高さとしたサインコサイン三角形の比で考えると良いでしょう</p>
                <p class="text">Fl変数は焦点距離を求めています。焦点距離から調整しようというわけですね</p>
                <p class="text">このグラフで式の関係も示されてるので話すことがないですね... 次に進みましょう。</p>
                <h2 class="text" id="rotate">カメラを回転させてみよう</h2>
                <p class="text">さて回転です。カメラを回転させてみましょう。ここまで来たら回転もやりたいですねぇ</p>
                <p class="text">ですが回転は大変です。今回は回転行列を使用せずにやってみたいと思います。</p>
                <p class="text">回転行列は計算が大変なので実はちょっとよろしくない。そこでクォータニオンという回転方法を使っていきます。</p>
                <p class="text">これのメリットは非常にたくさんあり、3Dの回転、姿勢を表すのに最も適していると思います。</p>
                <p class="text">唯一のデメリットは保存される値を見てもどのような回転かがイメージしにくいことですね。</p>
                <p class="text">ではクォータニオンとはいったい何なのでしょうか？</p>
                <p class="text">クォータニオンとは数学的には複素数の拡張を行った物です</p>
                <p class="text">プログラミングで複素数ってどうやって扱うねって感じがしますがこれはベクトルに置き換えて考えることで実現させます</p>
            </div>
        </main>
    </body>
</html>